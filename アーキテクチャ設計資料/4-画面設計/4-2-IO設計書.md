# 4-2-IO設計書

## 概要
画面項目とデータベース列のマッピング、JOIN方針、およびデータ処理ルールを定義する。

---

## 1. 登録画面（UI-001）- データマッピング

### 1.1 基本項目マッピング

| UI Field | UI Specs | → | DB Column | DB Specs | 変換処理 |
|----------|----------|---|-----------|----------|----------|
| name | text input, max 50文字, required | → | entries.name | VARCHAR(50) NOT NULL | 前後空白除去 |
| email | text input, max 255文字, email format, required | → | entries.email | VARCHAR(255) NOT NULL UNIQUE | 小文字変換、形式検証 |
| category | dropdown, required selection | → | entries.category_id | INTEGER NOT NULL FK | categories.id参照 |
| status | radio button, required selection | → | entries.status_id | INTEGER NOT NULL FK | statuses.id参照 |
| 同意 | checkbox, optional | → | entries.agree_newsletter | BOOLEAN DEFAULT FALSE | - |

### 1.2 関連テーブルマッピング

| UI項目名 | 関連処理 | 参照テーブル | JOIN方針 |
|----------|----------|-------------|----------|
| category | プルダウン選択肢取得 | categories | INNER JOIN |
| status | ラジオボタン選択肢取得 | statuses | INNER JOIN |
| tags | 複数選択（最大4個） | entry_tags, tags | LEFT OUTER JOIN |

### 1.3 自動設定項目

| DB列名 | 設定タイミング | 設定値 |
|--------|---------------|--------|
| id | INSERT時 | AUTO_INCREMENT |
| created_at | INSERT時 | CURRENT_TIMESTAMP |
| updated_at | INSERT/UPDATE時 | CURRENT_TIMESTAMP |

---

## 2. 一覧画面（UI-002）- データ取得

### 2.1 表示項目取得仕様

| 項目 | 内容 |
|------|------|
| **SELECT項目** | id, name, email, category_name, status_name, created_at, updated_at, tag_count |
| **主テーブル** | entries |
| **必須JOIN** | categories (INNER), statuses (INNER) |
| **任意JOIN** | entry_tags (LEFT OUTER) |
| **集約処理** | COUNT(tag_id) → tag_count |
| **グループ化** | id, name, email, category_name, status_name, created_at, updated_at |
| **ソート** | updated_at DESC（降順） |
| **ページング** | LIMIT/OFFSET対応 |

### 2.2 検索処理仕様

| UI検索項目 | 検索対象列 | 検索方式 | 備考 |
|------------|------------|----------|------|
| 名前またはメール | name, email | 部分一致（OR条件） | 大文字小文字区別なし |
| カテゴリーフィルタ | category_id | 完全一致 | プルダウン選択値 |
| ステータスフィルタ | status_id | 完全一致 | プルダウン選択値 |

---

## 3. 詳細画面（UI-003）- データ取得

### 3.1 基本情報取得仕様

| 項目 | 内容 |
|------|------|
| **SELECT項目** | entries全項目, category_name, status_name |
| **主テーブル** | entries |
| **必須JOIN** | categories (INNER), statuses (INNER) |
| **WHERE条件** | entries.id = 指定ID |
| **取得件数** | 1件 |

### 3.2 関連タグ取得仕様

| 項目 | 内容 |
|------|------|
| **SELECT項目** | label, code |
| **主テーブル** | tags |
| **必須JOIN** | entry_tags (INNER) |
| **WHERE条件** | entry_id = 指定ID |
| **ソート** | label（昇順） |

---

## 4. 更新画面（UI-004）- データマッピング

### 4.1 更新項目マッピング

| UI Field | UI Specs | → | DB Column | DB Specs | 更新処理 |
|----------|----------|---|-----------|----------|----------|
| name | text input, max 50文字, required | → | entries.name | VARCHAR(50) NOT NULL | 直接更新、長さチェック |
| email | text input, max 255文字, email format, required | → | entries.email | VARCHAR(255) NOT NULL UNIQUE | 一意性チェック後更新（自レコード除外） |
| category | dropdown, required selection | → | entries.category_id | INTEGER NOT NULL FK | categories.id存在チェック後更新 |
| status | radio button, required selection | → | entries.status_id | INTEGER NOT NULL FK | statuses.id存在チェック後更新 |
| tags | multi-select, max 4選択 | → | entry_tags.tag_id | INTEGER FK | 差分更新（全削除→新規追加） |
| 同意 | checkbox, optional | → | entries.agree_newsletter | BOOLEAN DEFAULT FALSE | 直接更新 |

### 4.2 タグ差分更新仕様

| 処理順序 | 操作 | 対象テーブル | 条件 | 備考 |
|----------|------|-------------|------|------|
| **1** | DELETE | entry_tags | entry_id = 指定ID | 既存関連削除 |
| **2** | INSERT | entry_tags | (entry_id, tag_id) | 新規関連追加（複数） |
| **制約** | - | - | 最大4件まで | UI側で制限 |

---

## 5. 削除確認（UI-005）- データ削除

### 5.1 論理削除処理

| テーブル | 削除方式 | 処理内容 |
|----------|----------|----------|
| entries | 論理削除 | deleted_at列にタイムスタンプ設定、WHERE条件：id = 指定ID |
| entry_tags | 物理削除 | レコード完全削除、WHERE条件：entry_id = 指定ID |

---

## 共通設計

### JOIN方針
- **categories/statuses**: **INNER JOIN** （必須関連）
- **tags/notes**: **LEFT OUTER JOIN** （任意関連）

### 監査ログ
重要操作/例外は `audit_logs` に記録（機密情報除外）

### データ整合性
- 外部キー制約による参照整合性保証
- アプリケーションレベルでの追加検証
- トランザクション境界での一貫性保証

### パフォーマンス考慮
- 一覧画面: ページネーション対応
- インデックス活用: email(UNIQUE), category_id, status_id
- N+1問題回避: 適切なJOIN使用