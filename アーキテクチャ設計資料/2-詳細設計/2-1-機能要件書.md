
---

## 機能要件書

### 1. 機能一覧

|機能ID|機能名|概要|対応画面|対応API|
|---|---|---|---|---|
|FR-020|登録|新規エントリを登録する機能|登録画面（UI-001）|POST /api/entries|
|FR-021|一覧|エントリを一覧表示し、検索・フィルタ・並び替えする機能|一覧画面（UI-002）|GET /api/entries|
|FR-022|詳細|単一エントリの詳細表示と削除実行|詳細画面（UI-003）|GET /api/entries/{id} / DELETE /api/entries/{id}|
|FR-023|更新|既存エントリを編集・更新する機能|更新画面（UI-004）|PUT /api/entries/{id}|
|FR-024|削除|エントリを削除する機能|削除確認ダイアログ（UI-005）|DELETE /api/entries/{id}|

---

### 2. 機能詳細

#### FR-020 登録（Create）
- **入力**  
  登録画面で `name, email, category, status, tags(0–4), agreeNewsletter`
- **処理**  
  1) バリデーション（必須・形式・長さ・email一意）  
  2) `entries` に INSERT、作成ID取得  
  3) 選択 `tags` を `entry_tags(entry_id, tag_id)` に一括INSERT  
  4) 監査ログ記録（CREATE）
- **出力**  
  成功：詳細(UI-003) or 一覧(UI-002)へ遷移（作成ID付き）  
  失敗：入力値保持＋エラーメッセージ表示

---

#### FR-021 一覧（Read-List）
- **入力**  
  クエリ：`q`（name/email 部分一致）, `category`, `status`, `page`, `size`, `sort`  
- **処理**  
  1) `entries` を基表に `categories/statuses` を **INNER JOIN**  
  2) 検索（ILIKE）、フィルタ、並び替え（既定：`updated_at DESC`）  
  3) タグ件数や最新ノートを表示する場合は集約/副問合せで **LEFT OUTER JOIN**  
  4) ページング（`LIMIT/OFFSET`）  
- **出力**  
  画面表：ID/名前/メール/カテゴリ/ステータス/作成日/更新日（必要に応じてタグ件数・最新ノート要約）  
  ページ情報：総件数・現在ページ

---

#### FR-022 詳細（Read-Detail）
- **入力**  
  パス：`{id}`
- **処理**  
  1) `entries` を主に `categories/statuses` を **INNER JOIN**  
  2) 関連タグ `tags` を `entry_tags` 経由で取得（**LEFT OUTER JOIN**）  
  3) `notes` 最新1件取得（**LEFT OUTER JOIN** + サブクエリ/ROW_NUMBER）  
- **出力**  
  全項目表示（id, name, email, category, status, tags, agreeNewsletter, createdAt, updatedAt, 最新ノート）  
  操作：更新へ/削除確認へ/一覧へ

---

#### FR-023 更新（Update）
- **入力**  
  パス：`{id}`、本文：`name, email, category, status, tags(0–4), agreeNewsletter`
- **処理**  
  1) 既存レコード取得 → 競合チェック（存在/楽観制御があれば検証）  
  2) バリデーション（必須・形式・長さ・email一意※自ID除外）  
  3) `entries` を UPDATE（`updated_at` 自動更新）  
  4) `entry_tags` を差分更新（追加/削除）  
  5) 監査ログ記録（UPDATE）
- **出力**  
  成功：詳細(UI-003)へ（更新後の値を再表示）  
  失敗：入力値保持＋エラーメッセージ表示

---

#### FR-024 削除（Delete）
- **入力**  
  パス：`{id}`（UI-005 で Yes 確認済み）
- **処理**  
  1) 参照整合性確認（`entry_tags` は ON DELETE CASCADE、他に参照があれば制御）  
  2) `entries` DELETE（先に `entry_tags` を自動/明示で削除）  
  3) 監査ログ記録（DELETE）
- **出力**  
  成功：一覧(UI-002)へトースト/通知表示「削除しました」  
  失敗：エラーメッセージ表示（必要に応じて詳細へ戻す）

---

### 共通エラーハンドリング（各機能で準用）
- バリデーション失敗：項目別メッセージ表示（必須/形式/一意/上限）  
- DB例外：ユーザーには汎用メッセージ、詳細は `audit_logs` に記録（機密除外）  
- 想定外例外：画面は安全な文言、`audit_logs` へ記録、HTTP 500 相当

---

### 3. 例外処理・制約

- email 重複時：エラーメッセージ「このメールは既に使用されています」
    
- category/status 未選択時：必須入力エラー
    
- DBエラー時：ユーザーには汎用エラーメッセージ、詳細は audit_logs に記録
    

---

### 4. 関連

- **画面**：UI-001 登録画面
    
- **API**：POST /api/entries
    

---
