# 5-3-ログ出力ガイドライン

## 1. 概要

本ドキュメントでは、研修生向けJava開発プロジェクトにおける最小限のログ出力ポリシーを定義します。
過度に複雑にならず、実践的なログ記録の基礎を学べることを目的としています。

## 2. ログレベルの使い分け

### 2.1 ERROR - エラーレベル
システムの正常な動作を妨げる重大な問題

**出力すべき内容：**
- データベース接続エラー
- SQLエラー（制約違反など）
- 予期しない例外
- ファイルアクセスエラー

**例：**
```java
log.error("ユーザー登録に失敗しました。Email重複: {}", email, e);
```

### 2.2 WARN - 警告レベル
処理は継続できるが、注意が必要な事象

**出力すべき内容：**
- ビジネスルール違反
- 非推奨機能の使用
- パフォーマンスの閾値超過
- リトライ処理

**例：**
```java
log.warn("無効なステータス変更が試行されました。ユーザーID: {}, 現在: {}, 要求: {}", 
         userId, currentStatus, requestedStatus);
```

### 2.3 INFO - 情報レベル
正常な処理の重要なマイルストーン

**出力すべき内容：**
- CRUD操作の完了（作成、更新、削除）
- ログイン/ログアウト
- バッチ処理の開始/終了
- 重要な状態変更

**例：**
```java
log.info("ユーザーが正常に登録されました。ID: {}, 名前: {}", user.getId(), user.getName());
log.info("ユーザー情報が更新されました。ID: {}", userId);
log.info("ユーザーが削除されました。ID: {}", userId);
```

### 2.4 DEBUG - デバッグレベル
開発時のデバッグ用（本番環境では無効化）

**出力すべき内容：**
- メソッドの開始/終了
- 変数の値
- SQL文
- 詳細な処理フロー

**例：**
```java
log.debug("findById開始。ID: {}", id);
log.debug("検索結果: {}", user);
```

## 3. 実装例

### 3.1 Loggerの定義

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Service
public class UserService {
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    
    // ...
}
```

### 3.2 サービスクラスでの実装例

```java
@Service
public class UserService {
    private static final Logger log = LoggerFactory.getLogger(UserService.class);
    
    public User createUser(User user) {
        try {
            // バリデーション
            if (userRepository.existsByEmail(user.getEmail())) {
                log.warn("メールアドレス重複: {}", user.getEmail());
                throw new DuplicateEmailException("このメールアドレスは既に使用されています");
            }
            
            // 保存処理
            User savedUser = userRepository.save(user);
            log.info("ユーザー登録完了 - ID: {}, 名前: {}, メール: {}", 
                    savedUser.getId(), savedUser.getName(), savedUser.getEmail());
            
            return savedUser;
            
        } catch (DataAccessException e) {
            log.error("ユーザー登録中にデータベースエラーが発生しました。メール: {}", 
                     user.getEmail(), e);
            throw new ServiceException("ユーザー登録に失敗しました", e);
        }
    }
    
    public void deleteUser(Long userId) {
        try {
            if (!userRepository.existsById(userId)) {
                log.warn("存在しないユーザーの削除が試行されました。ID: {}", userId);
                throw new UserNotFoundException("ユーザーが見つかりません");
            }
            
            userRepository.deleteById(userId);
            log.info("ユーザー削除完了 - ID: {}", userId);
            
        } catch (DataAccessException e) {
            log.error("ユーザー削除中にエラーが発生しました。ID: {}", userId, e);
            throw new ServiceException("ユーザー削除に失敗しました", e);
        }
    }
}
```

### 3.3 コントローラークラスでの実装例

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    private static final Logger log = LoggerFactory.getLogger(UserController.class);
    
    @PostMapping
    public ResponseEntity<User> createUser(@Valid @RequestBody User user) {
        log.info("ユーザー登録リクエスト受信 - 名前: {}", user.getName());
        
        try {
            User created = userService.createUser(user);
            return ResponseEntity.ok(created);
            
        } catch (DuplicateEmailException e) {
            log.warn("ユーザー登録失敗 - {}", e.getMessage());
            return ResponseEntity.badRequest().build();
            
        } catch (Exception e) {
            log.error("予期しないエラー", e);
            return ResponseEntity.internalServerError().build();
        }
    }
}
```

## 4. ログ出力設定

### 4.1 application.properties の設定

```properties
# ログレベル設定
logging.level.root=INFO
logging.level.com.javatraining.backend=INFO
logging.level.org.springframework.web=WARN
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE

# ファイル出力設定
logging.file.name=logs/application.log
logging.file.max-size=10MB
logging.file.max-history=30

# コンソール出力パターン
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n

# ファイル出力パターン
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n
```

## 5. ログ出力のベストプラクティス

### 5.1 やるべきこと
- ✅ ユーザーIDなど、追跡可能な識別子を含める
- ✅ エラーメッセージは日本語で分かりやすく
- ✅ 例外をログに記録する際は、スタックトレースも含める
- ✅ 機密情報（パスワード、クレジットカード番号）は絶対に記録しない

### 5.2 避けるべきこと
- ❌ パスワードや個人情報をログに出力
- ❌ すべてのメソッドにDEBUGログを追加
- ❌ 巨大なオブジェクトをそのままログ出力
- ❌ ループ内での過剰なログ出力

### 5.3 セキュリティ考慮事項

```java
// 悪い例
log.info("ログイン試行 - メール: {}, パスワード: {}", email, password);

// 良い例
log.info("ログイン試行 - メール: {}", email);
```

## 6. トラブルシューティング用ログ

問題が発生した際に調査しやすいよう、以下の情報を含めることを推奨：

```java
// リクエストIDを使った追跡
@Component
public class LoggingInterceptor extends HandlerInterceptorAdapter {
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        String requestId = UUID.randomUUID().toString();
        MDC.put("requestId", requestId);
        log.info("リクエスト開始 - {} {}", request.getMethod(), request.getRequestURI());
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) {
        log.info("リクエスト完了 - ステータス: {}", response.getStatus());
        MDC.clear();
    }
}
```

## 7. 研修生への推奨事項

1. **最初は少なめに**
   - 最初はINFOとERRORレベルのみを実装
   - 必要に応じて徐々に追加

2. **一貫性を保つ**
   - チーム内でログフォーマットを統一
   - 同じような処理には同じレベルのログを使用

3. **レビューの観点**
   - コードレビュー時にログの適切性も確認
   - 機密情報が含まれていないかチェック

## 8. まとめ

このガイドラインに従うことで、以下のメリットが得られます：

- 🎯 問題発生時の迅速な原因特定
- 📊 システムの動作状況の把握
- 🔍 監査要件への対応
- 📚 実践的なログ記録スキルの習得

研修プロジェクトでは、完璧なログ出力よりも、適切なログレベルの使い分けと、機密情報を記録しないという基本原則の理解が重要です。